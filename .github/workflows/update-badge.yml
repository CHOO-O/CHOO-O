name: Update README with latest blog post link

on:
  workflow_dispatch: # í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ìˆ˜ë™ ìˆ˜í–‰ í—ˆìš©
  schedule:
    - cron: "0 15 * * *" # ë§¤ì¼ 0ì‹œ (KST ê¸°ì¤€)ì— ìˆ˜í–‰ë˜ë„ë¡ í•¨

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      # 1. í˜„ì¬ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout profile repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PROFILE_REPO_TOKEN }} # ìˆ˜ì •ëœ ë¶€ë¶„
          repository: CHOO-O/CHOO-O

      # 2. badge/ ë””ë ‰í„°ë¦¬ ìƒì„± ë° ë§í¬ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Create badge directory
        run: mkdir -p badge

      - name: Download latest link file
        run: curl -s -o badge/latest-link.txt https://raw.githubusercontent.com/CHOO-O/CHOO-study/main/badge/latest-link.txt

      # 3. í˜„ì¬ READMEì— í¬í•¨ëœ ë§í¬ì™€ ë¹„êµ
      - name: Check if README needs update
        id: check
        run: |
          NEW_LINK=$(cat badge/latest-link.txt)
          grep -q "$NEW_LINK" README.md && echo "skip=true" >> $GITHUB_OUTPUT || echo "skip=false" >> $GITHUB_OUTPUT

      # 4. ë§í¬ ì¹˜í™˜ ë° ì»¤ë°‹
      - name: Update README.md with latest link
        if: steps.check.outputs.skip != 'true'
        run: |
          NEW_LINK=$(cat badge/latest-link.txt)
          sed -i "s|<!--LATEST_LINK_START-->.*<!--LATEST_LINK_END-->|<!--LATEST_LINK_START-->${NEW_LINK}<!--LATEST_LINK_END-->|" README.md

          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md

          if git diff --cached --quiet; then
            echo "â ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ìƒëµ"
          else
            git commit -m "ğŸ”„ Update latest blog post link"
            git push
          fi
